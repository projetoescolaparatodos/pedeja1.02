# ğŸ¯ DIAGRAMA VISUAL: Taxa de Entrega DinÃ¢mica

## 1ï¸âƒ£ ESTRUTURA GERAL DO SISTEMA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APLICATIVO FLUTTER (Mobile)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Produtos   â”‚      â”‚   Carrinho   â”‚      â”‚   Checkout   â”‚   â”‚
â”‚  â”‚   (CatÃ¡logo) â”‚â”€â”€â”€â”€â”€â†’â”‚   (CartPage) â”‚â”€â”€â”€â”€â”€â†’â”‚  (Pagamento) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                       â”‚            â”‚
â”‚                    âœ¨ MOSTRA TAXA âœ¨         ğŸ“¤ ENVIA PARA API   â”‚
â”‚                       DINÃ‚MICA                                    â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTP POST
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND (Node.js API)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  âœ… Recebe: items, subtotal, deliveryFee, etc                  â”‚
â”‚  âœ… Calcula: split financeiro (88/12 + dÃ©bitos)               â”‚
â”‚  âœ… Envia: transaÃ§Ã£o para Mercado Pago + OperaÃ§Ãµes DB         â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FIRESTORE (Database)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  restaurants/{id}:                                               â”‚
â”‚  â”œâ”€ name: "Burger King"                                          â”‚
â”‚  â”œâ”€ deliveryFee: 5.00 (taxa REAL)                               â”‚
â”‚  â””â”€ dynamicDeliveryFee: {       â† âœ¨ NOVO CAMPO                â”‚
â”‚     â”œâ”€ enabled: true                                             â”‚
â”‚     â””â”€ tiers: [                                                  â”‚
â”‚        â”œâ”€ { minValue: 0,  maxValue: 20, customerPays: 5.00 }  â”‚
â”‚        â”œâ”€ { minValue: 20, maxValue: 50, customerPays: 3.00 }  â”‚
â”‚        â””â”€ { minValue: 50, maxValue: null, customerPays: 0 }   â”‚
â”‚     ]                                                            â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2ï¸âƒ£ FLUXO DE CÃLCULO NO FLUTTER

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USUÃRIO ADICIONA PRODUTOS AO CARRINHO                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  CartState.addItem() â† Notifica      â”‚
        â”‚  _items.add(CartItem)                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“ notifyListeners()
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  CartPage rebuilda                   â”‚
        â”‚  Consumer<CartState>(...)            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ _buildCartSummary() calcula:                        â”‚
        â”‚                                                       â”‚
        â”‚ 1. subtotal = sum(item.totalPrice)                  â”‚
        â”‚    Exemplo: R$ 35,00                                â”‚
        â”‚                                                       â”‚
        â”‚ 2. Busca restaurant.dynamicDeliveryFee              â”‚
        â”‚    â”œâ”€ Se NÃƒO existe â†’ usa customerDeliveryFee       â”‚
        â”‚    â””â”€ Se NÃƒO existe â†’ usa deliveryFee padrÃ£o        â”‚
        â”‚                                                       â”‚
        â”‚ 3. Se existe taxa dinÃ¢mica:                          â”‚
        â”‚    â”œâ”€ Find tier where: tier.minValue â‰¤ 35           â”‚
        â”‚    â”‚                   AND tier.maxValue > 35        â”‚
        â”‚    â”œâ”€ Encontra: { minValue: 20, maxValue: 50,       â”‚
        â”‚    â”‚            customerPays: 3.00 }                â”‚
        â”‚    â””â”€ deliveryFee = 3.00                             â”‚
        â”‚                                                       â”‚
        â”‚ 4. Calcula total:                                    â”‚
        â”‚    total = subtotal + deliveryFee                    â”‚
        â”‚    total = 35.00 + 3.00 = 38.00                      â”‚
        â”‚                                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  EXIBE NA UI:                                        â”‚
        â”‚                                                       â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚  â”‚ Subtotal              R$ 35,00              â”‚   â”‚
        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
        â”‚  â”‚ Taxa de Entrega  ğŸ”„  R$ 3,00               â”‚   â”‚
        â”‚  â”‚ (varia com pedido)    [tooltip]            â”‚   â”‚
        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
        â”‚  â”‚ ğŸ“Š Faltam R$ 15 para frete grÃ¡tis!        â”‚   â”‚
        â”‚  â”‚    VocÃª economizaria R$ 3,00               â”‚   â”‚
        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
        â”‚  â”‚ TOTAL                 R$ 38,00              â”‚   â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â”‚                                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USUÃRIO CLICA "FINALIZAR PEDIDO"                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ OrderService.createOrder()                          â”‚
        â”‚                                                       â”‚
        â”‚ Calcula NOVAMENTE:                                   â”‚
        â”‚ â”œâ”€ subtotal = 35.00                                 â”‚
        â”‚ â”œâ”€ deliveryFee = 3.00                               â”‚
        â”‚ â”œâ”€ restaurantSubsidy = 5.00 - 3.00 = 2.00           â”‚
        â”‚ â””â”€ total = 38.00                                    â”‚
        â”‚                                                       â”‚
        â”‚ Monta payload:                                       â”‚
        â”‚ {                                                     â”‚
        â”‚   items: [...],                                      â”‚
        â”‚   subtotal: 35.00,                                   â”‚
        â”‚   paymentMethod: "credit_card",                      â”‚
        â”‚   delivery: {                                         â”‚
        â”‚     totalFee: 5.00,        â† Taxa REAL              â”‚
        â”‚     customerPaid: 3.00,    â† Taxa que cliente paga  â”‚
        â”‚     restaurantSubsidy: 2.00 â† Quanto restaurante    â”‚
        â”‚   },                                                  â”‚
        â”‚   ... mais campos ...                                â”‚
        â”‚ }                                                     â”‚
        â”‚                                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ HTTP POST /api/orders/create                        â”‚
        â”‚ (enviado ao Backend)                                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“ (vai para Backend)
```

---

## 3ï¸âƒ£ FLUXO NO BACKEND

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API BACKEND RECEBE: POST /api/orders/create                      â”‚
â”‚ Body: { items, subtotal, delivery: {totalFee, customerPaid...}} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ index.js (linha ~7365)                              â”‚
        â”‚                                                       â”‚
        â”‚ Extrai dados do pedido:                              â”‚
        â”‚ â”œâ”€ subtotal = 35.00                                 â”‚
        â”‚ â”œâ”€ deliveryFee = 5.00 (taxa real)                   â”‚
        â”‚ â”œâ”€ restaurantSubsidy = 2.00 (subsÃ­dio)              â”‚
        â”‚ â””â”€ customerDeliveryFee = 3.00 (cliente paga)        â”‚
        â”‚                                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ CÃLCULO DO SPLIT FINANCEIRO                         â”‚
        â”‚                                                       â”‚
        â”‚ restaurantGross = subtotal Ã— 0.88                    â”‚
        â”‚                 = 35 Ã— 0.88 = R$ 30,80              â”‚
        â”‚                                                       â”‚
        â”‚ restaurantSubsidyDeduction = 2.00                    â”‚
        â”‚                                                       â”‚
        â”‚ restaurantNet = restaurantGross - subsidy            â”‚
        â”‚               = 30.80 - 2.00 = R$ 28,80 âœ…          â”‚
        â”‚                                                       â”‚
        â”‚ platformCommission = subtotal Ã— 0.12 (ou 0.11 PIX)  â”‚
        â”‚                    = 35 Ã— 0.12 = R$ 4,20            â”‚
        â”‚                                                       â”‚
        â”‚ platformFee = commission + deliveryFee - subsidy     â”‚
        â”‚            = 4.20 + 5.00 - 2.00 = R$ 7,20           â”‚
        â”‚                                                       â”‚
        â”‚ customerPaymentTotal = subtotal + customerDeliveryFeeâ”‚
        â”‚                      = 35 + 3 = R$ 38,00            â”‚
        â”‚                                                       â”‚
        â”‚ mpFee = customerPaymentTotal Ã— 0.0099               â”‚
        â”‚       = 38 Ã— 0.0099 â‰ˆ R$ 0,38                       â”‚
        â”‚                                                       â”‚
        â”‚ VERIFICAÃ‡ÃƒO:                                         â”‚
        â”‚ restaurantNet + platformFee + mpFee = Total          â”‚
        â”‚ 28.80 + 7.20 + 0.38 = 36.38... (arredonda) âœ…       â”‚
        â”‚                                                       â”‚
        â”‚ âœ… SPLIT FUNCIONA PERFEITAMENTE COM TAXA DINÃ‚MICA!  â”‚
        â”‚                                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ SALVA NO FIRESTORE:                                 â”‚
        â”‚                                                       â”‚
        â”‚ orders/{orderId}: {                                  â”‚
        â”‚   items: [...],                                      â”‚
        â”‚   subtotal: 35.00,                                   â”‚
        â”‚   delivery: {                                         â”‚
        â”‚     totalFee: 5.00,        âœ…                         â”‚
        â”‚     customerPaid: 3.00,    âœ…                         â”‚
        â”‚     restaurantSubsidy: 2.00 âœ…                        â”‚
        â”‚   },                                                  â”‚
        â”‚   payment: {                                          â”‚
        â”‚     restaurantNet: 28.80,                             â”‚
        â”‚     platformFee: 7.20,                                â”‚
        â”‚     mpFee: 0.38                                       â”‚
        â”‚   },                                                  â”‚
        â”‚   ...                                                 â”‚
        â”‚ }                                                     â”‚
        â”‚                                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ CRIA PAGAMENTO NO MERCADO PAGO                      â”‚
        â”‚ (com application_fee calculado corretamente)        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4ï¸âƒ£ COMPARAÃ‡ÃƒO: Antes vs Depois

### âŒ ANTES (Taxa Fixa)

```
UsuÃ¡rio pede R$ 35
â”œâ”€ Taxa = sempre R$ 5,00 (fixa)
â”œâ”€ Total = R$ 40,00
â””â”€ Cliente sem opÃ§Ã£o de desconto

Restaurante:
â”œâ”€ Gross: 35 Ã— 0.88 = R$ 30,80
â”œâ”€ SubsÃ­dio: R$ 0,00
â”œâ”€ Net: R$ 30,80
â””â”€ Sem estratÃ©gia comercial
```

### âœ… DEPOIS (Taxa DinÃ¢mica)

```
UsuÃ¡rio pede R$ 35
â”œâ”€ Taxa = R$ 3,00 (encontrada na faixa 20-50)
â”œâ”€ Total = R$ 38,00
â”œâ”€ Cliente economiza R$ 2,00 âœ¨
â””â”€ UI mostra "Faltam R$ 15 para frete grÃ¡tis!" ğŸš€

Restaurante:
â”œâ”€ Gross: 35 Ã— 0.88 = R$ 30,80
â”œâ”€ SubsÃ­dio: R$ 2,00 (voluntÃ¡rio, estratÃ©gia comercial)
â”œâ”€ Net: R$ 28,80
â””â”€ Conquista clientes com frete mais barato!
```

---

## 5ï¸âƒ£ EXEMPLO: 3 CLIENTES, 3 CENÃRIOS

```
CONFIGURAÃ‡ÃƒO DO RESTAURANTE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Taxa Real (Entregador recebe): R$ 5,00  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Faixa 1: R$ 0-20   â†’ Cliente paga: R$ 5 â”‚
â”‚ Faixa 2: R$ 20-50  â†’ Cliente paga: R$ 3 â”‚
â”‚ Faixa 3: R$ 50+    â†’ Cliente paga: R$ 0 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CLIENTE 1: Pede R$ 15 (Pizza pequena)

App:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subtotal          R$ 15,00          â”‚
â”‚ Taxa de Entrega   R$ 5,00           â”‚  â† Faixa 1
â”‚ TOTAL             R$ 20,00          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

API recebe:
â”œâ”€ deliveryFee: 5.00
â”œâ”€ customerPaid: 5.00
â””â”€ restaurantSubsidy: 0.00

Split:
â”œâ”€ Restaurante: 15 Ã— 0.88 = R$ 13,20
â”œâ”€ Plataforma: 15 Ã— 0.12 + 5 = R$ 6,80
â”œâ”€ MP: 20 Ã— 0.99% = R$ 0,20
â””â”€ TOTAL: R$ 20,00 âœ…

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CLIENTE 2: Pede R$ 35 (2 Pizzas)

App:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subtotal           R$ 35,00          â”‚
â”‚ Taxa de Entrega    R$ 3,00           â”‚  â† Faixa 2
â”‚ TOTAL              R$ 38,00          â”‚
â”‚                                      â”‚
â”‚ ğŸ“Š Faltam R$ 15 para frete GRÃTIS!  â”‚
â”‚    VocÃª economizaria R$ 3,00         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

API recebe:
â”œâ”€ deliveryFee: 5.00
â”œâ”€ customerPaid: 3.00
â””â”€ restaurantSubsidy: 2.00 âœ¨ (estratÃ©gia!)

Split:
â”œâ”€ Restaurante: 35 Ã— 0.88 - 2 = R$ 28,80
â”œâ”€ Plataforma: 35 Ã— 0.12 + 5 - 2 = R$ 8,80
â”œâ”€ MP: 38 Ã— 0.99% = R$ 0,38
â””â”€ TOTAL: R$ 38,00 âœ…

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CLIENTE 3: Pede R$ 60 (Combo completo)

App:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subtotal           R$ 60,00          â”‚
â”‚ Taxa de Entrega    GRÃTIS! ğŸ‰        â”‚  â† Faixa 3
â”‚ TOTAL              R$ 60,00          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

API recebe:
â”œâ”€ deliveryFee: 5.00
â”œâ”€ customerPaid: 0.00
â””â”€ restaurantSubsidy: 5.00 âœ¨ (frete grÃ¡tis!)

Split:
â”œâ”€ Restaurante: 60 Ã— 0.88 - 5 = R$ 47,80
â”œâ”€ Plataforma: 60 Ã— 0.12 + 5 - 5 = R$ 7,20
â”œâ”€ MP: 60 Ã— 0.99% = R$ 0,60
â””â”€ TOTAL: R$ 60,00 âœ…
    nÃ• E
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

RESULTADO PARA O RESTAURANTE:

Cliente 1 (R$ 15):
â”œâ”€ Sem gasto extra
â””â”€ Cliente satisfeito com entrega normal

Cliente 2 (R$ 35):
â”œâ”€ Gasta R$ 2,00 de subsÃ­dio
â”œâ”€ Conquista cliente com desconto
â””â”€ ROI: Cliente pode pedir novamente!

Cliente 3 (R$ 60):
â”œâ”€ Gasta R$ 5,00 de subsÃ­dio
â”œâ”€ Oferece frete grÃ¡tis (estratÃ©gia de vendas)
â”œâ”€ Incentiva pedidos maiores
â””â”€ CompensaÃ§Ã£o: margem maior em pedidos grandes

ğŸ’° ESTRATÃ‰GIA COMERCIAL = LUCRATIVA!
```

---

## 6ï¸âƒ£ ESTRUTURA DE ARQUIVOS A MODIFICAR

```
lib/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ restaurant_model.dart
â”‚   â”‚   â””â”€ + dynamicDeliveryFee?: DynamicDeliveryFeeConfig
â”‚   â”‚
â”‚   â””â”€ dynamic_delivery_fee_model.dart âœ¨ NOVO!
â”‚      â”œâ”€ class DynamicDeliveryFeeConfig
â”‚      â””â”€ class DeliveryFeeTier
â”‚
â”œâ”€â”€ state/
â”‚   â””â”€â”€ cart_state.dart
â”‚      â”œâ”€ + calculateSubtotal()
â”‚      â”œâ”€ + calculateDeliveryFee(restaurant)
â”‚      â”œâ”€ + calculateSubsidy(restaurant)
â”‚      â””â”€ + calculateTotal(restaurant)
â”‚
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ cart/
â”‚   â”‚   â””â”€â”€ cart_page.dart
â”‚   â”‚      â””â”€ Mostrar taxa dinÃ¢mica + progresso
â”‚   â”‚
â”‚   â””â”€â”€ checkout/
â”‚       â””â”€â”€ checkout_page.dart
â”‚          â””â”€ (sem mudanÃ§as diretas, usa dados de CartState)
â”‚
â””â”€â”€ services/
    â””â”€â”€ order_service.dart
       â””â”€ Enviar delivery data corretamente para API
```

---

## 7ï¸âƒ£ CHECKLIST DE IMPLEMENTAÃ‡ÃƒO

```
PASSO 1: Models âœ¨
[ ] Criar dynamic_delivery_fee_model.dart
    - [ ] DynamicDeliveryFeeConfig class
    - [ ] DeliveryFeeTier class
    - [ ] fromMap() e toMap()
    - [ ] matches() method

[ ] Modificar restaurant_model.dart
    - [ ] Adicionar dynamicDeliveryFee field
    - [ ] Atualizar fromJson()
    - [ ] Atualizar toJson()

PASSO 2: Estado âœ¨
[ ] Modificar cart_state.dart
    - [ ] calculateSubtotal()
    - [ ] calculateDeliveryFee(restaurant)
    - [ ] calculateSubsidy(restaurant)
    - [ ] calculateTotal(restaurant)

PASSO 3: UI âœ¨
[ ] Modificar cart_page.dart
    - [ ] _buildCartSummary() mostra taxa dinÃ¢mica
    - [ ] Adicionar Ã­cone ğŸ”„ com tooltip
    - [ ] Adicionar barra de progresso
    - [ ] "Faltam R$ X para frete grÃ¡tis!"

PASSO 4: API âœ¨
[ ] Modificar order_service.dart
    - [ ] createOrder() calcula delivery data
    - [ ] Envia delivery object para API
    - [ ] Verify: customerPaid + restaurantSubsidy = deliveryFee

PASSO 5: Testes âœ¨
[ ] Teste 1: Pedido R$ 15 â†’ Taxa R$ 5, Total R$ 20
[ ] Teste 2: Pedido R$ 35 â†’ Taxa R$ 3, Total R$ 38
[ ] Teste 3: Pedido R$ 60 â†’ Taxa R$ 0, Total R$ 60
[ ] Teste 4: MÃºltiplos produtos (taxa recalcula)
[ ] Teste 5: Verificar dados enviados para API
[ ] Teste 6: Verificar split no backend
```

---

## âœ¨ RESUMO EXECUTIVO

### O QUE FAZ
âœ… Restaurante configura faixas de taxa (ex: 0-20=R$5, 20-50=R$3, 50+=R$0)  
âœ… App calcula taxa automaticamente baseado no subtotal  
âœ… UI mostra "Faltam R$ 15 para frete grÃ¡tis!" quando apropriado  
âœ… API recebe valores corretos e calcula split perfeitamente  

### O QUE NÃƒO MUDA
âŒ Split financeiro (88/12)  
âŒ DÃ©bitos automÃ¡ticos  
âŒ Taxas dinÃ¢micas (11%/12%)  
âŒ Sistema antigo (compatibilidade total)  

### IMPACTO
ğŸ“ˆ Maior conversÃ£o (clientes veem frete barato)  
ğŸ“ˆ Pedidos maiores (incentivo: "faltam R$ X para grÃ¡tis")  
ğŸ’° Restaurante controla estratÃ©gia (subsÃ­dio voluntÃ¡rio)  
ğŸ¯ Backend jÃ¡ 100% pronto  

---

